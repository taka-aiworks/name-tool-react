# 📖 AI漫画ネームメーカー - プロジェクトステータス

## 🎯 プロジェクト概要
AI漫画制作支援アプリケーション（ネーム段階）
- **テーマ**: 「AI漫画の描き方」を題材とした教育漫画
- **キャラクター**: リナ（初心者）× サユ（AI漫画の先生）
- **目標**: 100ページ前後のKDP出版対応漫画

## ✅ 完了した機能

### 🎨 UI/UX改善
- **統一カラーパレット**: 機能別色分けルールの実装
  - 💚 緑色系統 = ファイル操作（保存、作成）
  - 🔵 青色系統 = 出力・エクスポート
  - 🟠 オレンジ系統 = 編集・変更
  - 🔴 赤色系統 = 削除・危険操作
  - 🟣 紫色系統 = 設定・有効化
  - ⚫ グレー系統 = 管理・一覧

- **サイドバー整理**: 左・右サイドバーの開閉機能
- **ヘッダー整理**: 機能別ボタン配置の最適化
- **ダークモード完全対応**: 全モーダル・コンポーネント対応

### 💾 プロジェクト管理
- **保存機能の改善**: 新規保存時は名前入力、既存は上書き保存
- **プロジェクト一覧**: 作成日・更新日表示
- **インポート・エクスポート**: 完全対応
- **プロジェクト複製**: キャラクター情報含む完全複製
- **変更検知**: 未保存変更の自動検知と表示

### 🤖 AI機能統合
- **OpenAI API統合**: ストーリーからコマ内容自動生成
- **キャラクター登録**: AI Prompt Maker Web連携
- **プレビュー機能**: 2段階確認プロセス
- **プロンプト分離**: キャラクター・アクション別プロンプト

### 🔧 コマ操作機能
- **コマ入れ替え**: 直感的なクリック選択方式
- **コマ編集モード**: 詳細な編集機能
- **パネル設定**: AI生成の直下に配置
- **吹き出し編集**: 縦書き・横書き選択可能

### 📐 テンプレート・レイアウト
- **KDP出版対応**: 印刷用マージン設定
  - 上マージン: 20px
  - 左右マージン: 20px
  - 下マージン: 35px（ページ番号用スペース）
- **日本語読み順**: 右→左、上→下のコマ番号
- **テンプレート統一**: 全テンプレートの座標統一

### 📤 出力機能
- **プロンプト出力**: ページ・コマ別整理
- **NanoBanana対応**: 画像生成ツール連携
- **メモ機能**: 日本語メモ表示
- **キャラクタープロンプト**: 自動統合出力

## ⚠️ 現在の問題

### 🐛 アンドゥ/リドゥ機能の不具合
**重大度: 高**

#### 問題の詳細:
1. **履歴保存が不完全**
   - ✅ パネル追加・削除・分割・入れ替え: 履歴保存される
   - ❌ パネル移動・リサイズ: 履歴保存されない
   - ❌ キャラクター操作（追加・削除・移動・リサイズ）: 履歴保存されない
   - ❌ 吹き出し操作（追加・削除・移動・編集）: 履歴保存されない
   - ❌ 背景操作: 履歴保存されない
   - ❌ 効果操作: 履歴保存されない

2. **履歴保存の実装状況**
   - 手動履歴保存関数 (`saveHistoryManually`) が存在
   - 一部の操作でのみ呼び出されている
   - 統一的な履歴保存メカニズムが不足

3. **試行錯誤の経緯**
   - 当初: 自動履歴保存 → 操作カウントが異常増加
   - 次: 手動履歴保存のみ → 一部操作で履歴が保存されない
   - 次: ドラッグ開始/終了で履歴保存 → 実装不完全で動作しない
   - 現在: useEffectで状態監視 + 手動保存 → テスト未完了

#### 必要な修正:
1. **すべての操作で履歴保存を確実に実行**
   - パネル操作: 移動、リサイズ、追加、削除、分割、入れ替え
   - キャラクター操作: 追加、削除、移動、リサイズ、プロパティ変更
   - 吹き出し操作: 追加、削除、移動、リサイズ、テキスト編集
   - 背景操作: 追加、削除、移動、リサイズ
   - 効果操作: 追加、削除、移動、リサイズ
   - テンプレート変更
   - ページ切り替え

2. **デバウンス処理の実装**
   - 連続操作（ドラッグ中など）は1つの履歴として扱う
   - 500ms程度のタイムアウトで履歴保存

3. **アンドゥ/リドゥ実行中の履歴保存を防止**
   - `isUndoRedoExecuting` フラグの適切な管理

#### 技術的な課題:
- `CanvasComponent` で直接 `setCharacters` / `setSpeechBubbles` を呼んでいる
- MouseEventHandler で状態更新が行われる
- 履歴保存のタイミングを親コンポーネントから制御できない
- useEffect の依存配列管理が複雑

#### 暫定的な実装:
```typescript
// すべての状態変更を監視して履歴保存
useEffect(() => {
  if (operationHistory.currentIndex === -1) return;
  if (isUndoRedoExecuting) return;
  if (すべて空の状態) return;

  const timeoutId = setTimeout(() => {
    saveHistoryManually();
  }, 500);

  return () => clearTimeout(timeoutId);
}, [
  charactersSignature, 
  bubblesSignature, 
  panelsSignature, 
  backgroundsSignature, 
  effectsSignature
]);
```

**状態: テスト未完了、動作未確認**

## 🔄 進行中の作業
- **アンドゥ/リドゥ機能の完全修正**: すべての操作で履歴が保存されるように

## 📋 今後の予定
1. **漫画制作**: リナ×サユのストーリー展開
2. **プロンプト最適化**: AI生成品質の向上
3. **テンプレート拡張**: より多様なコマ割り
4. **エクスポート機能強化**: より多くのツール対応

## 🛠️ 技術スタック
- **Frontend**: React + TypeScript
- **Canvas**: HTML5 Canvas API
- **AI**: OpenAI GPT-4o-mini
- **Storage**: LocalStorage
- **Styling**: CSS Variables + カラーパレット

## 📁 主要ファイル構成
```
src/
├── App.tsx                    # メインアプリケーション
├── styles/colorPalette.ts     # 統一カラーパレット
├── components/
│   ├── CanvasArea/
│   │   ├── templates.ts       # KDP対応テンプレート
│   │   └── CanvasDrawing.ts   # キャンバス描画
│   └── UI/
│       ├── ProjectPanel.tsx   # プロジェクト管理
│       ├── ExportPanel.tsx    # 出力機能
│       └── StoryToComicModal.tsx # AI生成UI
├── services/
│   ├── OpenAIService.ts       # AI統合
│   └── SaveService.ts         # データ管理
└── hooks/
    ├── useProjectSave.ts      # プロジェクト保存
    └── usePageManager.ts      # ページ管理
```

## 🎯 完成度
- **UI/UX**: 95% 完了
- **基本機能**: 85% 完了（アンドゥ/リドゥ不具合）
- **AI統合**: 90% 完了
- **プロジェクト管理**: 100% 完了
- **出力機能**: 95% 完了

**総合完成度: 91%**（アンドゥ/リドゥ問題により低下）

## 🚀 次のマイルストーン
1. **最優先**: アンドゥ/リドゥ機能の完全修正
2. 漫画制作の本格開始
3. AI生成機能とプロンプト出力機能の最適化

## 📝 開発メモ
### アンドゥ/リドゥ実装の考察:
- **問題の根本原因**: 状態更新が多層的（App.tsx、CanvasComponent、MouseEventHandler）で行われ、履歴保存のタイミングを統一的に制御できない
- **解決策の候補**:
  1. すべての状態変更を `useEffect` で監視（現在の暫定実装）
  2. カスタムフックで状態管理と履歴保存を統合
  3. Redux/Zustand等の状態管理ライブラリ導入
  4. イベントバス/PubSubパターンで履歴保存イベントを統一管理
- **推奨アプローチ**: まずは useEffect 監視方式で動作確認し、問題があれば状態管理の全面リファクタリングを検討

---
*最終更新: 2025年10月11日*