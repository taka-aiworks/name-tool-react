# 📖 AI漫画ネームメーカー - プロジェクトステータス

## 🎯 プロジェクト概要
AI漫画制作支援アプリケーション（ネーム段階）
- **テーマ**: 「AI漫画の描き方」を題材とした教育漫画
- **キャラクター**: リナ（初心者）× サユ（AI漫画の先生）
- **目標**: 100ページ前後のKDP出版対応漫画

## ✅ 完了した機能

### 🎨 UI/UX改善
- **統一カラーパレット**: 機能別色分けルールの実装
  - 💚 緑色系統 = ファイル操作（保存、作成）
  - 🔵 青色系統 = 出力・エクスポート
  - 🟠 オレンジ系統 = 編集・変更
  - 🔴 赤色系統 = 削除・危険操作
  - 🟣 紫色系統 = 設定・有効化
  - ⚫ グレー系統 = 管理・一覧

- **サイドバー整理**: 左・右サイドバーの開閉機能
- **ヘッダー整理**: 機能別ボタン配置の最適化
- **ダークモード完全対応**: 全モーダル・コンポーネント対応

### 💾 プロジェクト管理
- **保存機能の改善**: 新規保存時は名前入力、既存は上書き保存
- **プロジェクト一覧**: 作成日・更新日表示
- **インポート・エクスポート**: 完全対応
- **プロジェクト複製**: キャラクター情報含む完全複製
- **変更検知**: 未保存変更の自動検知と表示

### 🤖 AI機能統合
- **OpenAI API統合**: ストーリーからコマ内容自動生成
- **キャラクター登録**: AI Prompt Maker Web連携
- **プレビュー機能**: 2段階確認プロセス
- **プロンプト分離**: キャラクター・アクション別プロンプト

### 🔧 コマ操作機能
- **コマ入れ替え**: 直感的なクリック選択方式
- **コマ編集モード**: 詳細な編集機能
- **パネル設定**: AI生成の直下に配置
- **吹き出し編集**: 縦書き・横書き選択可能

### 📐 テンプレート・レイアウト
- **KDP出版対応**: 印刷用マージン設定
  - 上マージン: 20px
  - 左右マージン: 20px
  - 下マージン: 35px（ページ番号用スペース）
- **日本語読み順**: 右→左、上→下のコマ番号
- **テンプレート統一**: 全テンプレートの座標統一

### 📤 出力機能
- **プロンプト出力**: ページ・コマ別整理
- **NanoBanana対応**: 画像生成ツール連携
- **メモ機能**: 日本語メモ表示
- **キャラクタープロンプト**: 自動統合出力

## ⚠️ 現在の問題

### 🐛 アンドゥ/リドゥ機能の不具合
**重大度: 高 - 要調査・再設計**

#### 現状の問題:
1. **履歴保存の挙動が不安定**
   - 元のコードに戻したが、挙動が変
   - 履歴が消える現象が発生
   - 勝手に履歴が増える問題も発生していた

2. **試行錯誤の失敗経緯:**
   - **最初（コミット 32380f4）**: 動作していた
     ```typescript
     useEffect(() => {
       if (すべて空) return;
       setTimeout(() => saveToHistory(...), 500);
     }, [charactersSignature, bubblesSignature, ...]);
     ```
   
   - **問題発覚**: 「何もしてないのに操作カウントが増える」
   
   - **誤った対応1**: useEffectを削除 → 一部操作で履歴が保存されない
   
   - **誤った対応2**: 手動履歴保存を追加 → 実装漏れが多数
   
   - **誤った対応3**: ドラッグイベント追加 → 実装不完全
   
   - **誤った対応4**: 条件分岐を追加（currentIndex, isUndoRedoExecuting） → 勝手に履歴が増える
   
   - **現在**: 元のコードに戻した → 履歴が消える

#### 根本的な問題:
- **状態管理の複雑さ**: App.tsx、CanvasComponent、MouseEventHandlerの3層で状態更新
- **useEffect依存配列の難しさ**: 何を入れても副作用が発生
- **デバッグの難しさ**: いつ履歴が保存されているか追跡困難

#### 必要な対応:
1. **詳細なログ追加**: いつ、何がトリガーで履歴保存されているか可視化
2. **再現手順の確立**: 具体的にどの操作で問題が起きるか特定
3. **根本的な再設計検討**: 
   - カスタムフックで履歴管理を分離
   - または状態管理ライブラリ（Redux/Zustand）導入
   - またはCommand パターンで操作を管理

#### 暫定的な回避策:
- ユーザーに手動で「保存」を促す
- アンドゥ/リドゥは慎重に使用
- 重要な作業前にプロジェクトを複製

**状態: 不安定、要再設計**

## 🔄 進行中の作業
- **アンドゥ/リドゥ機能の調査と再設計**: 根本的な解決が必要

## 📋 今後の予定
1. **漫画制作**: リナ×サユのストーリー展開
2. **プロンプト最適化**: AI生成品質の向上
3. **テンプレート拡張**: より多様なコマ割り
4. **エクスポート機能強化**: より多くのツール対応

## 🛠️ 技術スタック
- **Frontend**: React + TypeScript
- **Canvas**: HTML5 Canvas API
- **AI**: OpenAI GPT-4o-mini
- **Storage**: LocalStorage
- **Styling**: CSS Variables + カラーパレット

## 📁 主要ファイル構成
```
src/
├── App.tsx                    # メインアプリケーション
├── styles/colorPalette.ts     # 統一カラーパレット
├── components/
│   ├── CanvasArea/
│   │   ├── templates.ts       # KDP対応テンプレート
│   │   └── CanvasDrawing.ts   # キャンバス描画
│   └── UI/
│       ├── ProjectPanel.tsx   # プロジェクト管理
│       ├── ExportPanel.tsx    # 出力機能
│       └── StoryToComicModal.tsx # AI生成UI
├── services/
│   ├── OpenAIService.ts       # AI統合
│   └── SaveService.ts         # データ管理
└── hooks/
    ├── useProjectSave.ts      # プロジェクト保存
    └── usePageManager.ts      # ページ管理
```

## 🎯 完成度
- **UI/UX**: 95% 完了
- **基本機能**: 80% 完了（アンドゥ/リドゥ不安定）
- **AI統合**: 90% 完了
- **プロジェクト管理**: 100% 完了
- **出力機能**: 95% 完了

**総合完成度: 88%**（アンドゥ/リドゥ問題により低下）

### ⚠️ 既知の不具合:
- **アンドゥ/リドゥ**: 履歴保存の挙動が不安定（調査中）

## 🚀 次のマイルストーン
1. **最優先**: アンドゥ/リドゥ機能の完全修正
2. 漫画制作の本格開始
3. AI生成機能とプロンプト出力機能の最適化

## 📝 開発メモ

### アンドゥ/リドゥ実装の失敗分析:
**根本原因:**
- React の useEffect 依存配列の複雑さ
- 状態更新が3層（App.tsx → CanvasComponent → MouseEventHandler）に分散
- 履歴保存のタイミング制御が困難

**学んだこと:**
- useEffect で「すべての状態変更を監視」するアプローチは副作用が多い
- 依存配列を少しでも変更すると挙動が大きく変わる
- デバッグログなしでは何が起きているか追跡不可能

**次に試すべきアプローチ:**
1. **Command パターン**: すべての操作をコマンドオブジェクトとして管理
2. **Zustand + middleware**: 状態管理ライブラリで履歴を自動管理
3. **Immer + 手動スナップショット**: 操作完了時に明示的にスナップショット保存

**当面の対応:**
- アンドゥ/リドゥ機能は「おまけ」として扱う
- プロジェクト保存機能を充実させて、手動バックアップを推奨
- 漫画制作の本筋（AI生成、プロンプト出力）を優先

---
*最終更新: 2025年10月11日*